{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport \"core-js/modules/esnext.iterator.constructor.js\";\nimport \"core-js/modules/esnext.iterator.for-each.js\";\nimport \"core-js/modules/esnext.iterator.map.js\";\n/**\n * tdesign v1.10.5\n * (c) 2024 tdesign\n * @license MIT\n */\n\nimport { ref, createVNode, watch } from 'vue';\nimport '../adapt.mjs';\nimport TreeItem from '../tree-item.mjs';\nimport useTreeEvents from './useTreeEvents.mjs';\nimport { privateKey } from '../../_common/js/tree/tree-node.mjs';\nimport '../../utils/withInstall.mjs';\nimport '../../hooks/useVModel.mjs';\nimport '../../_chunks/dep-bad871d5.mjs';\nimport '../../_chunks/dep-eca422c3.mjs';\nimport '../../_chunks/dep-5a17bf21.mjs';\nimport '../../_chunks/dep-7932c2e8.mjs';\nimport '../../_chunks/dep-bf7257e7.mjs';\nimport '../../_chunks/dep-4659d73b.mjs';\nimport '../../_chunks/dep-eae2a67e.mjs';\nimport '../../_chunks/dep-626c497d.mjs';\nimport '../../_chunks/dep-ab4bb9b8.mjs';\nimport '../../_chunks/dep-29ef8419.mjs';\nimport '../../hooks/useDefaultValue.mjs';\nimport 'tdesign-icons-vue-next';\nimport '../../checkbox/index.mjs';\nimport '../../checkbox/checkbox.mjs';\nimport '../../_chunks/dep-5efe53d1.mjs';\nimport '../../_chunks/dep-593f2b67.mjs';\nimport '../../_chunks/dep-fa52aa21.mjs';\nimport '../../_chunks/dep-03a7fb6c.mjs';\nimport '../../checkbox/props.mjs';\nimport '../../hooks/useRipple.mjs';\nimport '../../hooks/useKeepAnimation.mjs';\nimport '../../hooks/useConfig.mjs';\nimport '../../config-provider/useConfig.mjs';\nimport '../../_chunks/dep-06dcbf4c.mjs';\nimport '../../_chunks/dep-2b09875b.mjs';\nimport '../../_chunks/dep-cda4f568.mjs';\nimport '../../_chunks/dep-bb899bfd.mjs';\nimport '../../_chunks/dep-5922c8f3.mjs';\nimport '../../_chunks/dep-92f86d1d.mjs';\nimport '../../_chunks/dep-6ab5363f.mjs';\nimport '../../_chunks/dep-6dc3d0e1.mjs';\nimport '../../_chunks/dep-76958824.mjs';\nimport '../../_chunks/dep-e9841b9e.mjs';\nimport '../../_chunks/dep-1a4bb2f2.mjs';\nimport '../../_chunks/dep-cc8ebcde.mjs';\nimport '../../_chunks/dep-f5579c03.mjs';\nimport '../../_chunks/dep-49aeee3c.mjs';\nimport '../../_chunks/dep-b5bf85f5.mjs';\nimport '../../_chunks/dep-3c65fae8.mjs';\nimport '../../_chunks/dep-ec0bbd9f.mjs';\nimport '../../_chunks/dep-1b78414a.mjs';\nimport '../../_chunks/dep-d84f19b3.mjs';\nimport '../../_chunks/dep-732f0b7d.mjs';\nimport '../../_chunks/dep-1b9718a2.mjs';\nimport '../../_chunks/dep-e065dc25.mjs';\nimport '../../_chunks/dep-400ec705.mjs';\nimport '../../_chunks/dep-02f9394e.mjs';\nimport '../../_chunks/dep-1725b1c7.mjs';\nimport '../../_chunks/dep-532409c5.mjs';\nimport '../../_common/js/global-config/default-config.mjs';\nimport '../../_common/js/global-config/locale/zh_CN.mjs';\nimport '../../_chunks/dep-9ed7da3e.mjs';\nimport '../../_chunks/dep-7f65fc46.mjs';\nimport '../../_chunks/dep-4f2cabb0.mjs';\nimport '../../config-provider/type.mjs';\nimport '../../utils/set-style.mjs';\nimport '../../hooks/tnode.mjs';\nimport '../../_chunks/dep-03ad9cda.mjs';\nimport '../../_chunks/dep-d8a34055.mjs';\nimport '../../_chunks/dep-2f6e28a0.mjs';\nimport '../../utils/render-tnode.mjs';\nimport '../../_chunks/dep-b91a8171.mjs';\nimport '../../checkbox/constants.mjs';\nimport '../../checkbox/hooks/useCheckboxLazyLoad.mjs';\nimport '../../_common/js/utils/observe.mjs';\nimport '../../checkbox/hooks/useKeyboardEvent.mjs';\nimport '../../_common/js/common.mjs';\nimport '../../hooks/useDisabled.mjs';\nimport '../../_chunks/dep-df472119.mjs';\nimport '../../hooks/useReadonly.mjs';\nimport '../../checkbox/group.mjs';\nimport '../../_chunks/dep-4a990ea3.mjs';\nimport '../../_chunks/dep-64c2053b.mjs';\nimport '../../_chunks/dep-4d4e2af1.mjs';\nimport '../../_chunks/dep-3c4e4325.mjs';\nimport '../../_chunks/dep-58a62202.mjs';\nimport '../../checkbox/checkbox-group-props.mjs';\nimport '../../hooks/slot.mjs';\nimport './style/css.mjs';\nimport '../../checkbox/type.mjs';\nimport '../../loading/index.mjs';\nimport '../../_chunks/dep-bff7e93a.mjs';\nimport '../../_chunks/dep-0b414bea.mjs';\nimport '../../_chunks/dep-fbd4eddb.mjs';\nimport '../../_chunks/dep-ae202bc0.mjs';\nimport '../../_chunks/dep-aeaef131.mjs';\nimport '../../_chunks/dep-69e0f6fc.mjs';\nimport '../../_chunks/dep-ea20409b.mjs';\nimport '../../loading/plugin.mjs';\nimport '../../loading/loading.mjs';\nimport '../../loading/icon/gradient.mjs';\nimport '../../_common/js/loading/circle-adapter.mjs';\nimport '../../_common/js/utils/set-style.mjs';\nimport '../../_common/js/utils/helper.mjs';\nimport '../../_chunks/dep-5d3f7c0e.mjs';\nimport '../../_chunks/dep-73384992.mjs';\nimport '../../_chunks/dep-889e457b.mjs';\nimport '../../utils/dom.mjs';\nimport '../../utils/easing.mjs';\nimport '../../loading/props.mjs';\nimport '../../hooks/useTeleport.mjs';\nimport '../../loading/type.mjs';\nimport '../../hooks/useGlobalIcon.mjs';\nimport '../../hooks/useLazyLoad.mjs';\nimport '../../hooks/useVirtualScrollNew.mjs';\nimport '../../hooks/useResizeObserver.mjs';\nimport '../../_chunks/dep-525a54df.mjs';\nimport '../../_chunks/dep-5993931e.mjs';\nimport '../../_chunks/dep-8dfc9324.mjs';\nimport '../../_chunks/dep-0d047dce.mjs';\nimport '../../_chunks/dep-f909a041.mjs';\nimport '../../_chunks/dep-e4a8ef7d.mjs';\nimport '../../_chunks/dep-d2f4e062.mjs';\nimport '../../_common/js/tree/tree-node-model.mjs';\nimport '../../_chunks/dep-88ae49da.mjs';\nimport '../../_chunks/dep-88c8d9ed.mjs';\nimport '../../_chunks/dep-4ec29b23.mjs';\nimport '../../_common/js/log/log.mjs';\nimport '../../_common/js/log/index.mjs';\nimport './useItemState.mjs';\nimport './useTreeItem.mjs';\nimport './useItemEvents.mjs';\nimport './useRenderIcon.mjs';\nimport '../util.mjs';\nimport './useRenderLabel.mjs';\nimport './useRenderLine.mjs';\nimport './useRenderOperations.mjs';\nimport './useDraggable.mjs';\nimport './useTreeAction.mjs';\nfunction useTreeNodes(state) {\n  var store = state.store,\n    scope = state.scope,\n    allNodes = state.allNodes,\n    nodes = state.nodes,\n    virtualConfig = state.virtualConfig;\n  var _useTreeEvents = useTreeEvents(state),\n    handleClick = _useTreeEvents.handleClick,\n    handleChange = _useTreeEvents.handleChange;\n  var nodesEmpty = ref(false);\n  var cacheMap = /* @__PURE__ */new Map();\n  var refresh = function refresh() {\n    allNodes.value = store.getNodes();\n  };\n  var refreshVisibleNodes = function refreshVisibleNodes() {\n    var isVirtual = virtualConfig === null || virtualConfig === void 0 ? void 0 : virtualConfig.isVirtualScroll.value;\n    if (isVirtual) return;\n    var list = [];\n    var hasVisibleNode = false;\n    allNodes.value.forEach(function (node) {\n      if (node.visible) {\n        hasVisibleNode = true;\n        cacheMap.set(node.value, node.value);\n      }\n      if (cacheMap.has(node.value)) {\n        list.push(node);\n      }\n    });\n    cacheMap.forEach(function (value) {\n      if (!store.getNode(value)) {\n        cacheMap[\"delete\"](value);\n      }\n    });\n    nodes.value = list;\n    nodesEmpty.value = !hasVisibleNode;\n  };\n  var refreshVirtualNodes = function refreshVirtualNodes() {\n    var isVirtual = virtualConfig === null || virtualConfig === void 0 ? void 0 : virtualConfig.isVirtualScroll.value;\n    if (!isVirtual) return;\n    var list = virtualConfig.visibleData.value;\n    nodes.value = list;\n    nodesEmpty.value = list.length <= 0;\n  };\n  var renderItem = function renderItem(h, node, index, stateId) {\n    var rowIndex = node.VIRTUAL_SCROLL_INDEX || index;\n    var nodeUniqueId = node[privateKey];\n    var treeItem = createVNode(TreeItem, {\n      \"key\": nodeUniqueId,\n      \"rowIndex\": rowIndex,\n      \"stateId\": stateId,\n      \"itemKey\": nodeUniqueId,\n      \"treeScope\": scope,\n      \"onClick\": handleClick,\n      \"onChange\": handleChange\n    }, null);\n    return treeItem;\n  };\n  var renderTreeNodes = function renderTreeNodes(h) {\n    var stateId = \"render-\".concat(new Date().getTime());\n    var treeNodeViews = nodes.value.map(function (node, index) {\n      return renderItem(h, node, index, stateId);\n    });\n    return treeNodeViews;\n  };\n  watch(allNodes, refreshVisibleNodes);\n  watch(virtualConfig.visibleData, refreshVirtualNodes);\n  refresh();\n  refreshVisibleNodes();\n  refreshVirtualNodes();\n  store.emitter.on(\"update\", refresh);\n  return {\n    nodesEmpty: nodesEmpty,\n    renderTreeNodes: renderTreeNodes\n  };\n}\nexport { useTreeNodes as default };","map":{"version":3,"names":["useTreeNodes","state","store","scope","allNodes","nodes","virtualConfig","_useTreeEvents","useTreeEvents","handleClick","handleChange","nodesEmpty","ref","cacheMap","Map","refresh","value","getNodes","refreshVisibleNodes","isVirtual","isVirtualScroll","list","hasVisibleNode","forEach","node","visible","set","has","push","getNode","refreshVirtualNodes","visibleData","length","renderItem","h","index","stateId","rowIndex","VIRTUAL_SCROLL_INDEX","nodeUniqueId","privateKey","treeItem","createVNode","TreeItem","renderTreeNodes","concat","Date","getTime","treeNodeViews","map","watch","emitter","on"],"sources":["../../../src/tree/hooks/useTreeNodes.tsx"],"sourcesContent":["import { ref, watch, TypeCreateElement, privateKey, TypeVNode } from '../adapt';\nimport { TypeTreeRow, TypeTreeNode, TypeTreeState } from '../tree-types';\nimport TreeItem from '../tree-item';\nimport useTreeEvents from './useTreeEvents';\n\n// tree 节点列表渲染\nexport default function useTreeNodes(state: TypeTreeState) {\n  const { store, scope, allNodes, nodes, virtualConfig } = state;\n  const { handleClick, handleChange } = useTreeEvents(state);\n  const nodesEmpty = ref(false);\n  // 用于存储已呈现节点的缓存\n  const cacheMap = new Map();\n\n  const refresh = () => {\n    allNodes.value = store.getNodes();\n  };\n\n  const refreshVisibleNodes = () => {\n    const isVirtual = virtualConfig?.isVirtualScroll.value;\n    if (isVirtual) return;\n    // 非虚拟滚动，渲染可视节点\n    const list: TypeTreeNode[] = [];\n    // 非虚拟滚动，缓存曾经展示过的节点\n    let hasVisibleNode = false;\n    allNodes.value.forEach((node: TypeTreeNode) => {\n      if (node.visible) {\n        // 曾经展示过的节点加入缓存，避免再次创建\n        hasVisibleNode = true;\n        cacheMap.set(node.value, node.value);\n      }\n      if (cacheMap.has(node.value)) {\n        // 创建的节点是缓存的节点\n        list.push(node);\n      }\n    });\n    cacheMap.forEach((value) => {\n      // 在缓存中清理结构变化后不存在的节点\n      if (!store.getNode(value)) {\n        cacheMap.delete(value);\n      }\n    });\n    // 渲染为平铺列表\n    nodes.value = list;\n    nodesEmpty.value = !hasVisibleNode;\n  };\n\n  const refreshVirtualNodes = () => {\n    const isVirtual = virtualConfig?.isVirtualScroll.value;\n    if (!isVirtual) return;\n    // 虚拟滚动只渲染可见节点\n    const list = virtualConfig.visibleData.value;\n    nodes.value = list;\n    nodesEmpty.value = list.length <= 0;\n  };\n\n  // 创建单个 tree 节点\n  const renderItem = (h: TypeCreateElement, node: TypeTreeRow, index: number, stateId: string) => {\n    const rowIndex = node.VIRTUAL_SCROLL_INDEX || index;\n    const nodeUniqueId = node[privateKey];\n    // vue3 中，不使用动画时，传递 node, 或者单纯传递 itemKey 无法触发 treeItem 的 render 方法\n    // 考虑到有必要对所有节点状态更新，所以添加 stateId 属性，专门用于触发 treeItem 的 render 方法\n    // 使用动画时，transition group 触发了所有节点的 render 方法，回头可以研究看下更合适的方案\n    // 未来也可以根据节点数据的具体更新状态，来决定节点更新与否\n    // 考虑到 value 值有冲突可能，所以使用 privateKey 来作为节点标记\n    const treeItem = (\n      <TreeItem\n        key={nodeUniqueId}\n        rowIndex={rowIndex}\n        stateId={stateId}\n        itemKey={nodeUniqueId}\n        treeScope={scope}\n        onClick={handleClick}\n        onChange={handleChange}\n      />\n    );\n    return treeItem;\n  };\n\n  const renderTreeNodes = (h: TypeCreateElement) => {\n    const stateId = `render-${new Date().getTime()}`;\n    const treeNodeViews: TypeVNode[] = nodes.value.map((node: TypeTreeNode, index) =>\n      renderItem(h, node, index, stateId),\n    );\n    return treeNodeViews;\n  };\n\n  watch(allNodes, refreshVisibleNodes);\n  watch(virtualConfig.visibleData, refreshVirtualNodes);\n\n  refresh();\n  refreshVisibleNodes();\n  refreshVirtualNodes();\n  store.emitter.on('update', refresh);\n\n  return {\n    nodesEmpty,\n    renderTreeNodes,\n  };\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}